---
- hosts: localhost
  connection: local
  environment:
    AWS_REGION: "{{ aws_secret_region }}"
  tasks:
    - route53:
        state: get
        zone: "{{ aws_route53_zone }}"
        record: "{{ elb_url }}"
        type: CNAME
      register: r53_info
    - elb_application_lb_info:
      register: elb_info
    - debug:
        msg: "{% for elb in elb_info.load_balancers %}\
            {% if elb.tags['kubernetes.io/cluster/ap-eks-cluster'] == 'owned' %}\
              {{ elb.dns_name }}\
            {% endif %}\
          {% endfor %}"
      register: eks_elb_dns
    - debug: { msg: "r53 is not set to the correct value! It's set to: {{r53_info.set.value}}" }
      when: r53_info.set.value != eks_elb_dns.msg
    - route53:
        state: present
        zone: "{{ aws_route53_zone }}"
        record: "{{ elb_url }}"
        type: CNAME
        value: "{{ eks_elb_dns.msg }}"
        overwrite: true
      when: r53_info.set.value != eks_elb_dns.msg